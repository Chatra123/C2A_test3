
Caption2Ass_PCR/Caption.dll     勝手にメンテ版  (2013/10/11)


【概要】

個人的な手入れを行う上で、一度コード全体を整理しておきたいと考え、メンテナンスを
実施したソース＆バイナリファイルです。

一部処理に関して動作仕様を変更、機能追加による拡張、も行っています。

その為、通常版と出力結果が異なる可能性があります。下記に記載した変更点の内容
を理解した上で、メリットがあると判断できた場合にのみ利用する事を推奨します。


【変更点】

2013/10/11
[動作影響：有]
-> [fix] Caption.dll のコード内、無限ループに陥る箇所のエラーチェック処理を追加
         (不具合を引き起こすファイルが手元にない為、動作結果は未確認)

[動作影響：無]
-> [ - ] コード整理 (削除/型変更)


2013/07/07
[動作影響：有]
-> [mod] 一行内における複数の装飾（フォント、色）をサポート
   [ - ] 上記対応の関連コードの整理


2013/06/26
[動作影響：無]
-> [ - ] コード修正 (改善/表示間違いを修正)


2013/06/24
[動作影響：無]
-> [ - ] コード整理 (削除/共通化/抽象化)


2013/06/23
[動作影響：有]
-> [Fix] -log 未使用時のクラッシュ不具合を修正  ※ Debug版は必ず、Relase版未確認
         (2013/06/19 のタイムスタンプ処理変更でのエンバグ)
-> [mod] ヘルプ表示内容のリダイレクトを可能にした
-> [mod] コード改善、という名の改造
         (出力内容は変わらない、私個人の好みによるコード変更。なのでmod)


2013/06/19

[動作影響：有]
-> [ - ] PCRの計算式にPCR_extも含める (計算上、精度を落としてるので出力影響無)
-> [ - ] コード改善 (共通コード/変数名を整理、エラーコードを定義、他)
-> [Fix] メモリリーク修正 (リークサイズは小、従来から解放処理が不足)
-> [mod] ログ出力内容の一部変更 (タイムスタンプの無効値: 0 -> -1、等)

-> [Fix] タイムスタンプ周りの処理(判定・計算)を改善、巡回判定も一律化
     ※ この変更において [experimental] 扱いとしていた修正コードと
        同等の条件判定を構築できたと見ています。
       （ただしTMSR4出力ファイルの動作は未確認、なんか変だったら報告下さい）

-> [mod] タイムスタンプの飛び判定における動作仕様を変更
     ※ ドロップ/CMカット＋結合 を検出する判定に関して、判定条件と動作仕様を
        以下の様に変更しました。

        <従来>  PCRが60秒以上の間隔を置いて検出された場合、
                PCR基準値を飛んだ時点の値で更新。
                (飛んだ位置から字幕時間が振り直しになる. なんで？)

        <mod>   PCRが100ミリ秒以上の間隔を置いて検出された場合、
                PCRが飛んだ時間分を補正値として計上し、出力字幕時間を調整。
                (pcr: 100ms間隔以内で検出される事が iso13818-1 の推奨)
                調整無(間隔維持)での出力も可能とする様に、'-keepinterval'
                オプションを追加。

     ※ [追加機能の補足説明] 参照


2013/06/17

[動作影響：有]
-> [Fix] -norubi オプションが無効化されていたバグを修正
         (2013/06/09 メンテでのエンバグ)


2013/06/14

[動作影響：無]
-> [ - ] コード改善 (初期化処理の追加、ヘッダ整理、コーディングスタイルの統一、他)
-> [mod] ヘルプ内容を書き直し


2013/06/09

[動作影響：無]
-> [ - ] ビルド時のワーニング除去 (#pragmaでの抑制も減らしたが C4100 のみ使用)
-> [ - ] exe/dll のプロジェクトを1つのsolutionファイルに纏めて管理する様、
         ソース構成を変更 (同一ソースは共通フォルダに纏めた)
-> [ - ] コード改善 (不要コード削除、グローバル変数削減、処理分割、等)
-> [ - ] x64ビルドを追加
-> [ - ] ビルドオプションの調整 (ランタイムライブラリのリンクを/MDに統一、他)

[動作影響：有]
-> [Fix] メモリーリーク修正
-> [Fix] ロングパスを扱う場合にバグるであろうコードを改善
         (exeの置き場次第でバグる。妥協有の実装だが改善を図った)
-> [Fix] ラップアラウンドの補正値を修正
         (+1/90ミリ秒、元々の影響は微々)
-> [mod] プログラム起動時のコンソールウィンドウのクリアー処理を除去
         (必要とは思えなかったので)
-> [Fix] 「【開発】 TS関連ソフトウェア総合スレ Part12」392の修正
         (動作確認済み)

[experimental]
-> [Fix] 「【開発】 TS関連ソフトウェア総合スレ Part12」371の修正


--------------------------------------------------------------------------------
【補足】

[残課題]
(1) TMSR4出力データでの確認 (保留。ファイルないですん...）
(2) 他 (コード改善、等)


[追加機能の補足説明]
   以下、ファイル状態とソフト動作を基に補足説明を記載します。

  -----------------------------------------------------------------------
    case :  CMカット＋結合ファイル (タイムスタンプ未調整) を再生
  -----------------------------------------------------------------------

        0:00       10:00    11:30       21:30    23:00     27:00
         |---------------------------------------------------|
    元   |     A     |   CM   |     B     |   CM   |    C    |
         |===========|        |===========|        |=========|

    Cut & Cat         ↓ ↓ ↓ ↓

        0:00       10:00       20:00     24:00
         |===========|===========|=========|
    新   |    A      |    B      |    C    |
         |===========|===========|=========|


    ・Marumo ISDB Splitter
      カット位置に差し掛かると、元のタイムスタンプに再生位置の時間が
      シークして再生を継続する。

        0:00                                               27:00
         |---------------------------------------------------|
         |     A     |   →   |     B     |   →   |    C    |
         |===========|  seek  |===========|  seek  |=========|
                        (*1)                 (*1)

      *1  再生時間とシークバーがカット前の位置に動く

      >>> -keepinterval を使用し、調整無(間隔維持)で出力した字幕を使う。
          もしくはカット前のTSで字幕を得ておく。  (*3)


    ・LAV Splitter
      カット位置に差し掛かると、再生位置の時間はカット分を詰めた状態
      となり再生を継続する。

        0:00                                               27:00
         |===========|===========|=========|-----------------|
         |    A      |    B      |    C    |
         |===========|===========|=========|      (*2)

      >>> オプション無で出力し、調整有(間隔を詰めた)の字幕を使う。

      *2  本件と関連する内容ではないが、シークバー上でシーク操作を行う
          と挙動がおかしくなる。

        例: Bの元範囲の時間にシーク ⇒ B先頭から再生
        (再生位置の表示時間は繋げた時の先頭ではなくバー上の移動位置)


  ここに挙げたSplitter以外で再生した場合、まったく別の挙動をする事も
  考えらます。
  CMカット＋結合を行った後、タイムスタンプの調整(例: TsTimeKeeperを使う)
  を行った上で本ソフトを使用するのが無難です。

  *3  元ファイルがあるなら -keepinterval 要らなくね？とも考えられますが、
      動作仕様を変更した影響により、パケットのdropがあった場合もCMカット
      同様に調整を行う様になっています。
      (従来版はdropがあっても60秒以内なら元位置維持の字幕を出力)
      この為、CMカット/drop分がシーク扱いとなる挙動に合わせた字幕を得る
      には本オプションを使用する必要があります。

  -----------------------------------------------------------------------



maki
